# Пользовательские истории moto-drag

## История 0. Первичная настройка и калибровка

- **Как** администратор трассы, первым подключившийся к устройству.
- **Хочу** пройти обязательный мастер настройки: задать название трассы, подтвердить текущую дату/время с телефона, откалибровать лазерные датчики и выбрать схему работы с одним или двумя лучами.
- **Чтобы** устройство знало базовую конфигурацию, использовало корректное время и имело стабильный порог срабатывания перед началом заездов.
- **Критерии приемки**:
  - Первый пользователь, открывший `http://moto.local` после включения, получает административные права и обязан завершить мастер; остальные пользователи ждут завершения.
  - Форма мастера содержит поля для названия трассы и автоматически подставленное время (`new Date()`), которое отправляется вместе с настройками.
  - Процесс настройки включает шаг калибровки фотодатчиков (одного или двух, если выбран режим определения направления) и сохраняет пороговые значения.
  - Конфигурация трассы, параметры калибровки и режим числа лучей записываются в SPIFFS и действуют до следующего административного сброса.

## История 1. Старт и завершение заезда

- **Как** мотоциклист Вася у подготовленной трассы с лазерным датчиком и LED-панелью.
- **Хочу** подключиться к открытой сети Wi‑Fi `moto-drag`, открыть `moto.local`, ввести имя, выбрать режим (1 круг или серия), задать число кругов и получить автоматический подсчет времени.
- **Чтобы** после первого пересечения луча таймер стартовал, второе срабатывание (заднее колесо) игнорировалось, далее каждое пересечение фиксировало круг или финиш; при необходимости можно было отменить текущий заезд кнопкой сброса; по завершении данные отображались на панели и сохранялись в истории.
- **Критерии приемки**:
  - Точка доступа устройства активна и перенаправляет на SPA по `http://moto.local`.
  - Форма содержит поля для имени, режима гонки и количества кругов; отправка без заполнения недоступна.
  - После нажатия пилотом кнопки «Готов» LED-панель отображает `00:00.000`, обновляясь каждые 100 мс до первого срабатывания датчика.
  - Таймер стартует строго по первому пересечению луча и не реагирует на второй импульс от заднего колеса; при двух лучах учитывается направление.
  - Для режима «1 круг» финиш фиксируется при следующем пересечении; для много-кругового режима каждый проход увеличивает счетчик кругов до заданного значения.
  - Кнопка сброса отменяет текущий заезд, останавливает таймер и возвращает панель к `00:00.000` без записи результата.
  - По завершении заезда LED-панель отображает результат (формат уточняется) бегущей строкой.
  - История всех завершенных заездов записывается в SPIFFS в формате JSONL (append-only, одна запись — один заезд) и доступна в веб-интерфейсе.

## История 2. Просмотр истории и рейтинга

- **Как** мотоциклист Петя, подключенный к `moto-drag`.
- **Хочу** увидеть список своих заездов и общий рейтинг по выбранной трассе.
- **Чтобы** анализировать прогресс и сравнивать результаты с другими на основании данных, сохраненных на устройстве.
- **Критерии приемки**:
  - В SPA есть раздел «Мои заезды», который фильтрует записи JSONL по имени текущего пользователя и отображает самодостаточные данные (имя, трасса, дата/время старта, времена кругов, итог).
  - В разделе «Топы» можно выбрать трассу по имени и переключаться между рейтингом по суммарному времени и по лучшему кругу; ничьи отображаются с одинаковым местом.
  - История хранится без перезаписи: новые заезды добавляются в JSONL-файл, старые записи остаются на месте.
  - Администратор может инициировать повторный запуск мастера для смены трассы или корректировки настроек; история при этом остается доступной.

## История 3. Обслуживание и надежность

- **Как** техник устройства.
- **Хочу** повторно откалибровать фотодатчики, активировать или отключить второй луч и управлять очисткой/переносом истории.
- **Чтобы** адаптировать систему под разные условия трассы, исключать ложные срабатывания и поддерживать память в рабочем состоянии.
- **Критерии приемки**:
  - В интерфейсе администратора доступна команда повторной калибровки, которая обновляет пороговые значения без удаления истории.
  - Переключение между режимами одного/двух лучей фиксируется в конфигурации и влияет на правила обработки пересечений (направление сохраняется в записи JSONL, если доступно).
  - Реализован append-only архив JSONL с возможностью выгрузки/скачивания; переполнение памяти требует административного решения (например, выгрузка и ручное удаление).
